import{a8 as h,fk as v,s as c,fl as D,fm as C,fn as N,fo as x,b3 as P,aQ as U,S as j,ci as b,eB as I,ed as M,d_ as f,fp as O}from"./index-6a6230c9.js";import{s as L}from"./geojson-a3636d8a.js";import{o as F,n as T}from"./xmlUtils-444cb4c0.js";function V(n){return X(n)??W(n)}function W(n){const t=new Date(n).getTime();return Number.isNaN(t)?null:t}function X(n){const t=z.exec(n);if(!(t!=null&&t.groups))return null;const e=t.groups,a=+e.year,s=+e.month-1,r=+e.day,o=+(e.hours??"0"),i=+(e.minutes??"0"),u=+(e.seconds??"0");if(o>23||i>59||u>59)return null;const p=e.ms??"0",l=p?+p.padEnd(3,"0").substring(0,3):0;let m;if(e.isUTC)m=Date.UTC(a,s,r,o,i,u,l);else if(e.offsetSign){const y=+e.offsetHours,d=+e.offsetMinutes;m=6e4*(e.offsetSign==="+"?-1:1)*(60*y+d)+Date.UTC(a,s,r,o,i,u,l)}else m=new Date(a,s,r,o,i,u,l).getTime();return Number.isNaN(m)?null:m}const z=/^(?:(?<year>-?\d{4,})-(?<month>\d{2})-(?<day>\d{2}))(?:T(?<hours>\d{2}):(?<minutes>\d{2}):(?<seconds>\d{2})(?:\.(?<ms>\d+))?)?(?:(?<isUTC>Z)|(?:(?<offsetSign>\+|-)(?<offsetHours>\d{2}):(?<offsetMinutes>\d{2})))?$/,S="xlink:href",g="2.0.0",E="__esri_wfs_id__",Y="wfs-layer:getWFSLayerTypeInfo-error",_="wfs-layer:empty-service",$="wfs-layer:feature-type-not-found",q="wfs-layer:geojson-not-supported",H="wfs-layer:kvp-encoding-not-supported",J="wfs-layer:malformed-json",k="wfs-layer:unknown-geometry-type",Q="wfs-layer:unknown-field-type",B="wfs-layer:unsupported-spatial-reference",K="wfs-layer:unsupported-wfs-version";async function Te(n,t){const e=Z((await h(n,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"GetCapabilities",VERSION:g,...t==null?void 0:t.customParameters},signal:t==null?void 0:t.signal})).data);return ne(n,e),e}function Z(n){const t=G(n);de(t),R(t);const e=t.firstElementChild,a=v(ae(e));return{operations:te(e),get featureTypes(){return Array.from(a())},readFeatureTypes:a}}const ee=new Set(["json","application/json","geojson","application/json; subtype=geojson"]);function te(n){let t=!1;const e={GetCapabilities:{url:""},DescribeFeatureType:{url:""},GetFeature:{url:"",outputFormat:null,supportsPagination:!1}};if(F(n,{OperationsMetadata:{Operation:a=>{switch(a.getAttribute("name")){case"GetCapabilities":return{DCP:{HTTP:{Get:s=>{e.GetCapabilities.url=s.getAttribute(S)}}}};case"DescribeFeatureType":return{DCP:{HTTP:{Get:s=>{e.DescribeFeatureType.url=s.getAttribute(S)}}}};case"GetFeature":return{DCP:{HTTP:{Get:s=>{e.GetFeature.url=s.getAttribute(S)}}},Parameter:s=>{if(s.getAttribute("name")==="outputFormat")return{AllowedValues:{Value:r=>{const o=r.textContent;o&&ee.has(o.toLowerCase())&&(e.GetFeature.outputFormat=o)}}}}}}},Constraint:a=>{switch(a.getAttribute("name")){case"KVPEncoding":return{DefaultValue:s=>{t=s.textContent.toLowerCase()==="true"}};case"ImplementsResultPaging":return{DefaultValue:s=>{e.GetFeature.supportsPagination=s.textContent.toLowerCase()==="true"}}}}}}),!t)throw new c(H,"WFS service doesn't support key/value pair (KVP) encoding");if(e.GetFeature.outputFormat==null)throw new c(q,"WFS service doesn't support GeoJSON output format");return e}function ne(n,t){D(n)&&(C(n,t.operations.DescribeFeatureType.url,!0)&&(t.operations.DescribeFeatureType.url=N(t.operations.DescribeFeatureType.url)),C(n,t.operations.GetFeature.url,!0)&&(t.operations.GetFeature.url=N(t.operations.GetFeature.url)))}function ae(n){return T(n,{FeatureTypeList:{FeatureType:t=>{const e={typeName:"undefined:undefined",name:"",title:"",description:"",extent:null,namespacePrefix:"",namespaceUri:"",supportedSpatialReferences:[]},a=new Set([4326]),s=r=>{var i,u,p;const o=parseInt(((p=(u=(i=r.textContent)==null?void 0:i.match(/(?<wkid>\d+$)/i))==null?void 0:u.groups)==null?void 0:p.wkid)??"",10);Number.isNaN(o)||a.add(o)};return F(t,{Name:r=>{const{name:o,prefix:i}=w(r.textContent);e.typeName=`${i}:${o}`,e.name=o,e.namespacePrefix=i,e.namespaceUri=r.lookupNamespaceURI(i)},Abstract:r=>{e.description=r.textContent},Title:r=>{e.title=r.textContent},WGS84BoundingBox:r=>{e.extent=re(r)},DefaultSRS:s,DefaultCRS:s,OtherSRS:s,OtherCRS:s}),e.title||(e.title=e.name),e.supportedSpatialReferences.push(...a),e}}})}function re(n){let t,e,a,s;for(const r of n.children)switch(r.localName){case"LowerCorner":[t,e]=r.textContent.split(" ").map(o=>Number.parseFloat(o));break;case"UpperCorner":[a,s]=r.textContent.split(" ").map(o=>Number.parseFloat(o))}return{xmin:t,ymin:e,xmax:a,ymax:s,spatialReference:b}}function se(n,t,e){return x(n,a=>e?a.name===t&&a.namespaceUri===e:a.typeName===t||a.name===t)}async function he(n,t,e,a={}){const{featureType:s,extent:r}=await oe(n,t,e,a),{fields:o,geometryType:i,swapXY:u,objectIdField:p,geometryField:l}=await ie(n,s.typeName,a);return{url:n.operations.GetCapabilities.url,name:s.name,namespaceUri:s.namespaceUri,fields:o,geometryField:l,geometryType:i,objectIdField:p,spatialReference:a.spatialReference??P.WGS84,extent:r,swapXY:u,wfsCapabilities:n,customParameters:a.customParameters}}async function oe(n,t,e,a={}){const{spatialReference:s=P.WGS84}=a,r=n.readFeatureTypes(),o=t?se(r,t,e):r.next().value;if(o==null)throw t?new c($,`The type '${t}' could not be found in the service`):new c(_,"The service is empty");let i=new U({...o.extent,spatialReference:s});if(!j(s,b))try{await I(b,s,void 0,a),i=M(i,b)}catch{throw new c(B,"Projection not supported")}return{extent:i,spatialReference:s,featureType:o}}async function ie(n,t,e={}){var l,m,y;const[a,s]=await Promise.allSettled([le(n.operations.DescribeFeatureType.url,t,e),pe(n,t,e)]),r=d=>new c(Y,`An error occurred while getting info about the feature type '${t}'`,{error:d});if(a.status==="rejected")throw r(a.reason);if(s.status==="rejected")throw r(s.reason);const{fields:o,errors:i}=a.value??{},u=((l=a.value)==null?void 0:l.geometryType)||((m=s.value)==null?void 0:m.geometryType),p=((y=s.value)==null?void 0:y.swapXY)??!1;if(u==null)throw new c(k,`The geometry type could not be determined for type '${t}`,{typeName:t,geometryType:u,fields:o,errors:i});return{...ue(o??[]),geometryType:u,swapXY:p}}function ue(n){const t=n.find(a=>a.type==="geometry");let e=n.find(a=>a.type==="oid");return n=n.filter(a=>a.type!=="geometry"),e||(e=new f({name:E,type:"oid",alias:E}),n.unshift(e)),{geometryField:(t==null?void 0:t.name)??null,objectIdField:e.name,fields:n}}async function pe(n,t,e={}){var u;let a,s=!1;const[r,o]=await Promise.all([fe(n.operations.GetFeature.url,t,n.operations.GetFeature.outputFormat,{...e,count:1}),h(n.operations.GetFeature.url,{responseType:"text",query:A(t,void 0,{...e,count:1}),signal:e==null?void 0:e.signal})]),i=r.type==="FeatureCollection"&&((u=r.features[0])==null?void 0:u.geometry);if(i){let p;switch(a=O.fromJSON(L(i.type)),i.type){case"Point":p=i.coordinates;break;case"LineString":case"MultiPoint":p=i.coordinates[0];break;case"MultiLineString":case"Polygon":p=i.coordinates[0][0];break;case"MultiPolygon":p=i.coordinates[0][0][0]}const l=/<[^>]*pos[^>]*> *(-?\d+(?:\.\d+)?) (-?\d+(?:\.\d+)?)/.exec(o.data);if(l){const m=p[0].toFixed(3),y=p[1].toFixed(3),d=parseFloat(l[1]).toFixed(3);m===parseFloat(l[2]).toFixed(3)&&y===d&&(s=!0)}}return{geometryType:a,swapXY:s}}async function le(n,t,e){return ce(t,(await h(n,{responseType:"text",query:{SERVICE:"WFS",REQUEST:"DescribeFeatureType",VERSION:g,TYPENAME:t,...e==null?void 0:e.customParameters},signal:e==null?void 0:e.signal})).data)}function ce(n,t){const{name:e}=w(n),a=G(t);R(a);const s=x(T(a.firstElementChild,{element:r=>({name:r.getAttribute("name"),typeName:w(r.getAttribute("type")).name})}),({name:r})=>r===e);if(s!=null){const r=x(T(a.firstElementChild,{complexType:o=>o}),o=>o.getAttribute("name")===s.typeName);if(r!=null)return ye(r)}throw new c($,`Type '${n}' not found in document`,{document:new XMLSerializer().serializeToString(a)})}const me=new Set(["objectid","fid"]);function ye(n){const t=[],e=[];let a;const s=T(n,{complexContent:{extension:{sequence:{element:r=>r}}}});for(const r of s){const o=r.getAttribute("name");if(!o)continue;let i,u;if(r.hasAttribute("type")?i=w(r.getAttribute("type")).name:F(r,{simpleType:{restriction:m=>(i=w(m.getAttribute("base")).name,{maxLength:y=>{u=+y.getAttribute("value")}})}}),!i)continue;const p=r.getAttribute("nillable")==="true";let l=!1;switch(i.toLowerCase()){case"integer":case"nonpositiveinteger":case"negativeinteger":case"long":case"int":case"short":case"byte":case"nonnegativeinteger":case"unsignedlong":case"unsignedint":case"unsignedshort":case"unsignedbyte":case"positiveinteger":e.push(new f({name:o,alias:o,type:"integer",nullable:p}));break;case"float":case"double":case"decimal":e.push(new f({name:o,alias:o,type:"double",nullable:p}));break;case"boolean":case"string":case"gyearmonth":case"gyear":case"gmonthday":case"gday":case"gmonth":case"anyuri":case"qname":case"notation":case"normalizedstring":case"token":case"language":case"idrefs":case"entities":case"nmtoken":case"nmtokens":case"name":case"ncname":case"id":case"idref":case"entity":case"duration":case"time":e.push(new f({name:o,alias:o,type:"string",nullable:p,length:u??255}));break;case"datetime":case"date":e.push(new f({name:o,alias:o,type:"date",nullable:p,length:u??36}));break;case"pointpropertytype":a="point",l=!0;break;case"multipointpropertytype":a="multipoint",l=!0;break;case"curvepropertytype":case"multicurvepropertytype":case"multilinestringpropertytype":a="polyline",l=!0;break;case"surfacepropertytype":case"multisurfacepropertytype":case"multipolygonpropertytype":a="polygon",l=!0;break;case"geometrypropertytype":case"multigeometrypropertytype":l=!0,t.push(new c(k,`geometry type '${i}' is not supported`,{type:new XMLSerializer().serializeToString(n)}));break;default:t.push(new c(Q,`Unknown field type '${i}'`,{type:new XMLSerializer().serializeToString(n)}))}l&&e.push(new f({name:o,alias:o,type:"geometry",nullable:p}))}for(const r of e)if(r.type==="integer"&&!r.nullable&&me.has(r.name.toLowerCase())){r.type="oid";break}return{geometryType:a,fields:e,errors:t}}async function fe(n,t,e,a){var r;let{data:s}=await h(n,{responseType:"text",query:A(t,e,a),signal:a==null?void 0:a.signal});s=s.replaceAll(/": +(-?\d+),(\d+)(,)?/g,'": $1.$2$3');try{if((r=a==null?void 0:a.dateFields)!=null&&r.length){const o=new Set(a.dateFields);return JSON.parse(s,(i,u)=>o.has(i)?V(u):u)}return JSON.parse(s)}catch(o){throw new c(J,"Error while parsing the response",{response:s,error:o})}}function A(n,t,e){return{SERVICE:"WFS",REQUEST:"GetFeature",VERSION:g,TYPENAMES:n,OUTPUTFORMAT:t,SRSNAME:"EPSG:4326",STARTINDEX:e==null?void 0:e.startIndex,COUNT:e==null?void 0:e.count,...e==null?void 0:e.customParameters}}function G(n){return new DOMParser().parseFromString(n.trim(),"text/xml")}function w(n){const[t,e]=n.split(":");return{prefix:e?t:"",name:e??t}}function de(n){var e;const t=(e=n.firstElementChild)==null?void 0:e.getAttribute("version");if(t&&t!==g)throw new c(K,`Unsupported WFS version ${t}. Supported version: ${g}`)}function R(n){let t="",e="";if(F(n.firstElementChild,{Exception:a=>(t=a.getAttribute("exceptionCode"),{ExceptionText:s=>{e=s.textContent}})}),t)throw new c(`wfs-layer:${t}`,e)}export{se as $,E as F,he as M,fe as Q,ue as X,Te as k};
