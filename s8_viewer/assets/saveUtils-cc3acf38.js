import{as as w,at as I,au as g,s as S,av as f}from"./index-6a6230c9.js";import{getSiblingOfSameTypeI as v}from"./resourceUtils-78e7719e.js";async function k(r,e,o){if(!e||!e.resources)return;const t=e.portalItem===r.portalItem?new Set(r.paths):new Set;r.paths.length=0,r.portalItem=e.portalItem;const a=new Set(e.resources.toKeep.map(s=>s.resource.path)),n=new Set,c=[];a.forEach(s=>{t.delete(s),r.paths.push(s)});for(const s of e.resources.toUpdate)if(t.delete(s.resource.path),a.has(s.resource.path)||n.has(s.resource.path)){const{resource:h,content:m,finish:l,error:d}=s,p=v(h,w());r.paths.push(p.path),c.push(i({resource:p,content:m,compress:s.compress,finish:l,error:d},o))}else r.paths.push(s.resource.path),c.push(y(s,o)),n.add(s.resource.path);for(const s of e.resources.toAdd)c.push(i(s,o)),r.paths.push(s.resource.path);if(t.forEach(s=>{if(e.portalItem){const h=e.portalItem.resourceFromPath(s);c.push(h.portalItem.removeResource(h).catch(()=>{}))}}),c.length===0)return;const u=await I(c);if(g(o),u.length>0)throw new S("save:resources","Failed to save one or more resources",{errors:u})}async function i(r,e){var a,n;const o={...e??{},compress:r.compress},t=await f(r.resource.portalItem.addResource(r.resource,r.content,o));if(t.ok!==!0)throw(a=r.error)==null||a.call(r,t.error),t.error;(n=r.finish)==null||n.call(r,r.resource)}async function y(r,e){var t,a;const o=await f(r.resource.update(r.content,e));if(o.ok!==!0)throw(t=r.error)==null||t.call(r,o.error),o.error;(a=r.finish)==null||a.call(r,r.resource)}export{k as saveResources};
