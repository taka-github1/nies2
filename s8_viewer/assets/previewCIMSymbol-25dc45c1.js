import{gi as Q,au as K,gj as Z,gk as M,dN as k,gl as $,a8 as ee,dQ as te,gm as ae,gn as A,dU as E}from"./index-6a6230c9.js";import{r as ie,n as B,i as L,e as re,G as ne,V as oe,Q as se}from"./cimAnalyzer-6cdd137c.js";import{i as le}from"./CIMResourceManager-605517f8.js";import{c as ce}from"./Rasterizer-129b44e6.js";import{t as G,l as he}from"./symbolUtils-213d17df.js";import"./fontUtils-9bdd13b2.js";import"./BidiEngine-9a40f2f4.js";import"./OptimizedGeometry-196224d4.js";import"./GeometryUtils-984e8446.js";import"./enums-f1a6a48a.js";import"./alignmentUtils-ae955d28.js";import"./definitions-706e5a41.js";import"./number-e491b09e.js";import"./Rect-ea14f53a.js";import"./quantizationUtils-b8e39672.js";import"./floatRGBA-6b040bc0.js";import"./imageUtils-f0fa6f9b.js";import"./imageutils-a9d675f5.js";import"./rasterizingUtils-9217d732.js";import"./webStyleSymbolUtils-6cfdefea.js";import"./devEnvironmentUtils-5002a058.js";var Y;(function(g){g.Legend="legend",g.Preview="preview"})(Y||(Y={}));const T=g=>g&&g.scaleFactor?g.scaleFactor:1,me=96/72;class ge{constructor(e,t){this._spatialReference=e,this._avoidSDF=t,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new ie,this._cimResourceManager=new le,this._rasterizer=new ce(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,n,i,a,r,l,o){if(!e)return null;const{data:f}=e;if(!f||f.type!=="CIMSymbolReference"||!f.symbol)return null;const{symbol:p}=f;r||(r=Q(p));const d=await B.resolveSymbolOverrides(f,t,this._spatialReference,a,r,l,o);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const m=this._imageDataCanvas,h=this._cimResourceManager,y=[];L.fetchResources(d,h,y),L.fetchFonts(d,h,y),y.length>0&&await Promise.all(y);const{width:c,height:u}=n,C=ue(r,c,u,i),s=L.getEnvelope(d,C,h);if(!s)return null;const b=(window.devicePixelRatio||1)*me;let w=1,z=0,x=0;switch(p.type){case"CIMPointSymbol":case"CIMTextSymbol":{let P=1;s.width>c&&(P=c/s.width);let F=1;s.height>u&&(F=u/s.height),i==="preview"&&(s.width<c&&(P=c/s.width),s.height<u&&(F=u/s.height)),w=Math.min(P,F),z=s.x+s.width/2,x=s.y+s.height/2}break;case"CIMLineSymbol":{w=u/s.height,x=s.y+s.height/2;const P=s.x*w+c/2,F=(s.x+s.width)*w+c/2,{paths:_}=C;_[0][0][0]-=P/w,_[0][2][0]-=(F-c)/w}break;case"CIMPolygonSymbol":{z=s.x+s.width/2,x=s.y+s.height/2;const P=s.x*w+c/2,F=(s.x+s.width)*w+c/2,_=s.y*w+u/2,D=(s.y+s.height)*w+u/2,{rings:S}=C;P<0&&(S[0][0][0]-=P,S[0][3][0]-=P,S[0][4][0]-=P),_<0&&(S[0][0][1]+=_,S[0][1][1]+=_,S[0][4][1]+=_),F>c&&(S[0][1][0]-=F-c,S[0][2][0]-=F-c),D>u&&(S[0][2][1]+=D-u,S[0][3][1]+=D-u)}}m.width=c*b,m.height=u*b;const v=1;m.width+=2*v,m.height+=2*v;const R=m.getContext("2d"),I=se.createIdentity();return I.translate(-z,-x),I.scale(w*b,-w*b),I.translate(c*b/2+v,u*b/2+v),R.clearRect(0,0,m.width,m.height),new re(R,h,I,!0).drawSymbol(d,C),R.getImageData(0,0,m.width,m.height)}async analyzeCIMSymbol3D(e,t,n,i,a){const r=[],l=t?{geometryType:i,spatialReference:this._spatialReference,fields:t}:null,o=[];L.fetchFonts(e.data.symbol,this._cimResourceManager,o),await Promise.all(o);const f=new ne(this._cimResourceManager,l);let p;await f.analyzeSymbolReference(e.data,this._avoidSDF,r),K(a);for(const d of r)d.cim.type!=="CIMPictureMarker"&&d.cim.type!=="CIMPictureFill"&&d.cim.type!=="CIMPictureStroke"||(p||(p=[]),p.push(this._fetchPictureMarkerResource(d,a))),n&&d.type==="text"&&typeof d.text=="string"&&d.text.includes("[")&&(d.text=Z(n,d.text,d.cim.textCase));return p&&await Promise.all(p),r}rasterizeCIMSymbol3D(e,t,n,i,a,r){const l=[];for(const o of e){i&&typeof i.scaleFactor=="function"&&(i.scaleFactor=i.scaleFactor(t,a,r));const f=this._getRasterizedResource(o,t,n,i,a,r);if(!f)continue;let p=0,d=f.anchorX||0,m=f.anchorY||0,h=!1,y=0,c=0;if(n==="esriGeometryPoint"){const u=T(i);if(y=M(o.offsetX,t,a,r)*u||0,c=M(o.offsetY,t,a,r)*u||0,o.type==="marker")p=M(o.rotation,t,a,r)||0,h=o.rotateClockwise??!1;else if(o.type==="text"){if(p=M(o.angle,t,a,r)||0,o.horizontalAlignment!==void 0)switch(o.horizontalAlignment){case"left":d=-.5;break;case"right":d=.5;break;default:d=0}if(o.verticalAlignment!==void 0)switch(o.verticalAlignment){case"top":m=.5;break;case"bottom":m=-.5;break;case"baseline":m=-.25;break;default:m=0}}}f!=null&&l.push({angle:p,rotateClockWise:h,anchorX:d,anchorY:m,offsetX:y,offsetY:c,rasterizedResource:f})}return this.getSymbolImage(l)}getSymbolImage(e){const t=document.createElement("canvas"),n=t.getContext("2d");let i=0,a=0,r=0,l=0;const o=[];for(let m=0;m<e.length;m++){const h=e[m],y=h.rasterizedResource;if(!y)continue;const c=y.size,u=h.offsetX,C=h.offsetY,s=h.anchorX,b=h.anchorY,w=h.rotateClockWise||!1;let z=h.angle,x=k(u)-c[0]*(.5+s),v=k(C)-c[1]*(.5+b),R=x+c[0],I=v+c[1];if(z){w&&(z=-z);const _=Math.sin(z*Math.PI/180),D=Math.cos(z*Math.PI/180),S=x*D-v*_,H=x*_+v*D,j=x*D-I*_,W=x*_+I*D,N=R*D-I*_,U=R*_+I*D,V=R*D-v*_,q=R*_+v*D;x=Math.min(S,j,N,V),v=Math.min(H,W,U,q),R=Math.max(S,j,N,V),I=Math.max(H,W,U,q)}i=x<i?x:i,a=v<a?v:a,r=R>r?R:r,l=I>l?I:l;const P=n.createImageData(y.size[0],y.size[1]);P.data.set(new Uint8ClampedArray(y.image.buffer));const F={offsetX:u,offsetY:C,rotateClockwise:w,angle:z,rasterizedImage:P,anchorX:s,anchorY:b};o.push(F)}t.width=r-i,t.height=l-a;const f=-i,p=l;for(let m=0;m<o.length;m++){const h=o[m],y=this._imageDataToCanvas(h.rasterizedImage),c=h.rasterizedImage.width,u=h.rasterizedImage.height,C=f-c*(.5+h.anchorX),s=p-u*(.5-h.anchorY);if(h.angle){const b=(360-h.angle)*Math.PI/180;n.save(),n.translate(k(h.offsetX),-k(h.offsetY)),n.translate(f,p),n.rotate(b),n.translate(-f,-p),n.drawImage(y,C,s),n.restore()}else n.drawImage(y,C+k(h.offsetX),s-k(h.offsetY))}const d=new $({x:f/t.width-.5,y:p/t.height-.5});return{imageData:t.width!==0&&t.height!==0?n.getImageData(0,0,t.width,t.height):n.createImageData(1,1),anchorPosition:d}}async _fetchPictureMarkerResource(e,t){const n=e.materialHash;if(!this._pictureMarkerCache.get(n)){const i=(await ee(e.cim.url,{responseType:"image",signal:t&&t.signal})).data;this._pictureMarkerCache.set(n,i)}}_imageDataToCanvas(e){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const t=this._imageDataCanvas,n=t.getContext("2d");return t.width=e.width,t.height=e.height,n.putImageData(e,0,0),t}_imageTo32Array(e,t,n,i){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,r=a.getContext("2d");if(a.width=t,a.height=n,r.drawImage(e,0,0,t,n),i){r.save();const l=new te(i);r.fillStyle=l.toHex(),r.globalCompositeOperation="multiply",r.fillRect(0,0,t,n),r.globalCompositeOperation="destination-atop",r.drawImage(e,0,0,t,n),r.restore()}return new Uint32Array(r.getImageData(0,0,t,n).data.buffer)}_getRasterizedResource(e,t,n,i,a,r){let l,o,f;if(e.type==="text")return this._rasterizeTextResource(e,t,i,a,r);({analyzedCIM:l,hash:o}=fe(e,t,a,r));const m=T(i);if(e.cim.type==="CIMPictureMarker"){const c=M(e.size,t,a,r)*m,{image:u,width:C,height:s}=this._getPictureResource(e,c,M(e.color,t,a,r));return f={image:u,size:[C,s],sdf:!1,simplePattern:!1,anchorX:e.anchorPoint?e.anchorPoint.x:0,anchorY:e.anchorPoint?e.anchorPoint.y:0},f}ae(l,m,{preserveOutlineWidth:!1});const h=l;o+=n,i&&(o+=JSON.stringify(i));const y=this._resourceCache;return y.has(o)?y.get(o):(f=this._rasterizer.rasterizeJSONResource({cim:h,type:e.type,url:e.url,mosaicHash:o,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),y.set(o,f),f)}_rasterizeTextResource(e,t,n,i,a){var v,R,I;const r=T(n),l=M(e.text,t,i,a);if(!l||l.length===0)return null;const o=e.cim,f=M((o==null?void 0:o.fontFamilyName)||e.fontName,t,i,a),p=M(((v=o==null?void 0:o.font)==null?void 0:v.style)||e.style,t,i,a),d=M(((R=o==null?void 0:o.font)==null?void 0:R.weight)||e.weight,t,i,a),m=M(((I=o==null?void 0:o.font)==null?void 0:I.decoration)||e.decoration,t,i,a),h=M(e.size,t,i,a)*r,y=M(e.horizontalAlignment,t,i,a),c=M(e.verticalAlignment,t,i,a),u=A(M(e.color,t,i,a)),C=A(M(e.outlineColor,t,i,a)),s=M(e.outlineSize,t,i,a),b=e.backgroundColor!=null?A(e.backgroundColor):null,w=e.borderLineColor!=null?A(e.borderLineColor):null,z=e.borderLineWidth!=null?e.borderLineWidth:null,x={color:u,size:h,horizontalAlignment:y,verticalAlignment:c,font:{family:f,style:p,weight:d,decoration:m},halo:{size:s||0,color:C,style:p},backgroundColor:b,borderLine:w!=null&&z!=null?{color:w,size:z}:null,pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(l,x)}_getPictureResource(e,t,n){const i=this._pictureMarkerCache.get(e.materialHash);if(!i)return null;const a=i.height/i.width,r=t?a>1?k(t):k(t)/a:i.width,l=t?a>1?k(t)*a:k(t):i.height;return{image:this._imageTo32Array(i,r,l,n),width:r,height:l}}}function ue(g,e,t,n){const a=-e/2+1,r=e/2-1,l=t/2-1,o=-t/2+1;switch(g){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[a,0],[0,0],[r,0]]]};default:return n==="legend"?{rings:[[[a,l],[r,0],[r,o],[a,o],[a,l]]]}:{rings:[[[a,l],[r,l],[r,o],[a,o],[a,l]]]}}}function fe(g,e,t,n){let i,a;return typeof g.materialHash=="function"?(i=(0,g.materialHash)(e,t,n),a=oe(g.cim,g.materialOverrides)):(i=g.materialHash,a=g.cim),{analyzedCIM:a,hash:i}}const X=new ge(null,!0),O=E(G.size),J=E(G.maxSize),de=E(G.lineWidth),ye=1;async function pe(g,e,t){const n=e==null?void 0:e.size;let i=n!=null&&typeof n=="object"&&"width"in n?n.width:n,a=n!=null&&typeof n=="object"&&"height"in n?n.height:n;if(i==null||a==null)if(t==="esriGeometryPolygon")i=O,a=O;else{const r=await we(g,e,t);r&&(i=r.width,a=r.height)}return t==="esriGeometryPolyline"&&(i=de),{width:i!=null&&isFinite(i)?Math.min(i,J):O,height:a!=null&&isFinite(a)?Math.max(Math.min(a,J),ye):O}}async function we(g,e,t){const{feature:n,fieldMap:i}=e.cimOptions||e,a=await B.resolveSymbolOverrides(g.data,n,null,i,t);if(!a)return null;(g=g.clone()).data={type:"CIMSymbolReference",symbol:a},g.data.primitiveOverrides=void 0;const r=[];return L.fetchResources(a,X.resourceManager,r),L.fetchFonts(a,X.resourceManager,r),r.length>0&&await Promise.all(r),L.getEnvelope(a,null,X.resourceManager)}async function Ge(g,e={}){var w;const{node:t,opacity:n,symbolConfig:i}=e,a=i!=null&&typeof i=="object"&&"isSquareFill"in i&&i.isSquareFill,r=e.cimOptions||e,l=r.geometryType||Q((w=g==null?void 0:g.data)==null?void 0:w.symbol),o=await pe(g,e,l),{feature:f,fieldMap:p}=r,d=a||l!=="esriGeometryPolygon"?Y.Preview:Y.Legend,m=await X.rasterizeCIMSymbolAsync(g,f,o,d,p,l);if(!m)return null;const{width:h,height:y}=m,c=document.createElement("canvas");c.width=h,c.height=y,c.getContext("2d").putImageData(m,0,0);const u=k(o.width),C=k(o.height),s=new Image(u,C);s.src=c.toDataURL(),s.ariaLabel=e.ariaLabel??null,s.alt=e.ariaLabel??"",n!=null&&(s.style.opacity=`${n}`);let b=s;if(e.effectView!=null){const z={shape:{type:"image",x:0,y:0,width:u,height:C,src:s.src},fill:null,stroke:null,offset:[0,0]};b=he([[z]],[u,C],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return t&&b&&t.appendChild(b),b}export{Ge as previewCIMSymbol};
